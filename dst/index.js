async function t(t,e,n,o){const a=await async function(t){return(await await fetch(t)).text()}(e),c=t.createShader(n);return t.shaderSource(c,a),t.compileShader(c),function(t,e,n){const o=t.getShaderInfoLog(e);o&&console.error(n+"\n",o)}(t,c,e),t.attachShader(o,c),c}async function e(e,n,o){const a=e.createProgram();await t(e,n,e.VERTEX_SHADER,a),await t(e,o,e.FRAGMENT_SHADER,a),e.linkProgram(a);const c=e.getProgramInfoLog(a);return c&&console.error(n,o+"\n",c),a}function n(t,e,n,o,a,c){const s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,o,e,n,0,a,c,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),s}function o(t,e,o){const a=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,a);const c=n(t,e,o,t.RGBA32F,t.RGBA,t.FLOAT);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,c,0);const s=n(t,e,o,t.RGBA32F,t.RGBA,t.FLOAT);return t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT1,t.TEXTURE_2D,s,0),{t:a,o:c,color:s}}async function a(){const t=document.createElement("canvas");t.id="fluid-canvas",t.width=1024,t.height=1024;const a=t.getContext("webgl2",{antialias:!1});console.log(a.getExtension("EXT_color_buffer_float")),console.log(a.getExtension("OES_texture_float_linear")),a.viewport(0,0,t.width,t.height),a.clearColor(1,0,0,1),a.clear(a.COLOR_BUFFER_BIT);const f=a.createVertexArray();a.bindVertexArray(f);const h=await async function(t){const e=new Int8Array(await(await fetch("assets")).arrayBuffer());console.log("assets",e);const n=e[0];let o=1;const a=[];for(let c=0;c<n;c++){let n=e[o++];n<0&&(n=256+n);const c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,e.slice(o,o+3*n),t.STATIC_DRAW),console.log("vertices",Array.from(e.slice(o,o+3*n)).map((t=>t/128))),o+=3*n;let s=e[o++];s<0&&(s=256+s),s*=3;const i=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.slice(o,o+s),t.STATIC_DRAW),console.log("indices",e.slice(o,o+s)),o+=s,a.push([c,i,s])}return a}(a);console.log(h);const u=await e(a,"3d.vert","3d.frag"),[m,v,p,y,g,b,_,x]=await Promise.all(["advect.frag","divergence.frag","pressure.frag","final.frag","blit.frag","init.frag","display.frag","circle.frag"].map((t=>e(a,"blit.vert",t))));let k=o(a,t.width,t.height),A=o(a,t.width,t.height),S=o(a,128,128);const F=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,F);const E=n(a,t.width,t.height,a.RGBA,a.RGBA,a.UNSIGNED_BYTE);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,E,0);const G=n(a,t.width,t.height,a.DEPTH_COMPONENT16,a.DEPTH_COMPONENT,a.UNSIGNED_SHORT);a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,G,0);const L=function(t){const e=new Float32Array([-1,-1,1,-1,-1,1,1,-1,-1,1,1,1]),n=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),n}(a);function T(){a.bindFramebuffer(a.DRAW_FRAMEBUFFER,A.t),a.drawBuffers([a.COLOR_ATTACHMENT0]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,k.o)}function q(){[k,A]=[A,k],T()}a.bindFramebuffer(a.FRAMEBUFFER,k.t),a.bindBuffer(a.ARRAY_BUFFER,L),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(0),a.drawBuffers([a.COLOR_ATTACHMENT0,a.COLOR_ATTACHMENT1]),a.useProgram(b),a.drawArrays(a.TRIANGLES,0,6);let D=[0,0],H=[0,0];t.addEventListener("mousemove",(t=>{D=[t.offsetX,t.offsetY]}));let I=!1,J=0;t.addEventListener("mousedown",(t=>{J=t.button,I=!0,H=[t.offsetX,t.offsetY],t.preventDefault()}));let N=[0,0];document.addEventListener("mouseup",(t=>{I=!1,pendingGust=!0;let e=t.offsetX-H[0],n=t.offsetY-H[1];N=[e,n],console.log(N),t.preventDefault()})),document.oncontextmenu=()=>!1;let O=0;function P(t,e,n,o,c,s=0){a.uniformMatrix4fv(a.getUniformLocation(u,"vp"),!1,[1,0,0,0,0,Math.cos(1.3),-Math.sin(1.3),0,0,Math.sin(1.3),Math.cos(1.3),0,0,0,0,1]);for(let i=0;i<2;i++)a.bindBuffer(a.ARRAY_BUFFER,h[t][0]),a.vertexAttribPointer(0,3,a.BYTE,!0,0,0),a.enableVertexAttribArray(0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h[t][1]),a.uniformMatrix4fv(a.getUniformLocation(u,"m"),!1,[Math.cos(c)*o,0,Math.sin(c)*o,0,0,1*o*(1===i?0:1),0,0,-Math.sin(c)*o,0,Math.cos(c)*o,0,e,0,n,1]),a.uniform1i(a.getUniformLocation(u,"mode"),0===i?s:1),a.drawElements(a.TRIANGLES,h[t][2],a.UNSIGNED_BYTE,0)}const U=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,U),a.bufferData(a.PIXEL_PACK_BUFFER,262144,a.DYNAMIC_READ);const X=new Float32Array(65536);return{canvas:t,loop:function(){a.bindFramebuffer(a.READ_FRAMEBUFFER,k.t),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,S.t),a.drawBuffers([a.COLOR_ATTACHMENT0,a.COLOR_ATTACHMENT1]),a.blitFramebuffer(0,0,t.width,t.height,0,0,128,128,a.COLOR_BUFFER_BIT,a.LINEAR),a.bindFramebuffer(a.READ_FRAMEBUFFER,S.t),a.readBuffer(a.COLOR_ATTACHMENT0),a.readPixels(0,0,128,128,a.RGBA,a.FLOAT,0);const e=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);T(),a.useProgram(m),a.uniform1i(a.getUniformLocation(m,"fields"),0),a.drawArrays(a.TRIANGLES,0,6),q(),a.useProgram(v),a.drawArrays(a.TRIANGLES,0,6),q(),a.useProgram(p);for(let t=0;t<20;t++)a.drawArrays(a.TRIANGLES,0,6),q();a.useProgram(y),a.drawBuffers([a.COLOR_ATTACHMENT0,a.COLOR_ATTACHMENT1]),a.uniform1i(a.getUniformLocation(y,"fields"),0),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,k.color),a.uniform1i(a.getUniformLocation(y,"color"),1),a.uniform1i(a.getUniformLocation(y,"gust_type"),2===J?1:0),a.uniform2fv(a.getUniformLocation(y,"force_pos"),[H[0]/window.innerWidth,1-H[1]/window.innerHeight]),a.uniform2fv(a.getUniformLocation(y,"force_vec"),[.1*N[0],.1*-N[1]]),N=[0,0],a.drawArrays(a.TRIANGLES,0,6),q(),a.useProgram(x);for(const t of c.units)if(t.i===d){const e=1===t.l;a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,k.o),a.uniform1i(a.getUniformLocation(x,"fields"),0),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,k.color),a.uniform1i(a.getUniformLocation(x,"colors"),1),a.drawBuffers([a.COLOR_ATTACHMENT0,a.COLOR_ATTACHMENT1]),a.uniform1f(a.getUniformLocation(x,"force_factor"),e?1:0),a.uniform3f(a.getUniformLocation(x,"circle"),t.x,t.y,e?.04:.004),a.uniform4f(a.getUniformLocation(x,"colors_change"),0,e?1:.3,0,0),a.drawArrays(a.TRIANGLES,0,6),q()}a.useProgram(u),a.uniform1i(a.getUniformLocation(u,"fields"),0),a.uniform1f(a.getUniformLocation(u,"time"),O),a.enable(a.DEPTH_TEST),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,F),a.clearColor(.7,.75,.85,0),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(const t of c.units){if(void 0===w[t.i])continue;const e=2*t.x-1,n=2*t.y-1;switch(P(w[t.i],e,n,M[t.i],t.r),t.i){case s:case i:P(3,e,n,.2,0,3);break;case l:case r:P(3,e,n,.2,0,4)}}I&&P(2,H[0]/window.innerWidth*2-1,0-(H[1]/window.innerHeight*2-1),1*Math.hypot(D[1]-H[1],D[0]-H[0])/window.innerWidth,Math.atan2(-(D[1]-H[1]),D[0]-H[0]),2),a.bindBuffer(a.ARRAY_BUFFER,L),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.disable(a.DEPTH_TEST),a.useProgram(_),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,null),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,k.color),a.uniform1i(a.getUniformLocation(_,"atmosphere"),0),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,E),a.uniform1i(a.getUniformLocation(_,"render_layer"),1),a.uniform2fv(a.getUniformLocation(_,"rand_noise"),[Math.random(),Math.random()]),a.drawArrays(a.TRIANGLES,0,6),O++;const n=a.getParameter(a.MAX_CLIENT_WAIT_TIMEOUT_WEBGL);a.clientWaitSync(e,a.SYNC_FLUSH_COMMANDS_BIT,n),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,X),a.h=D},u:X}}let c={screen:0,M:0,units:[]};const s=0,i=1,l=2,r=3,f=4,h=5,d=6,u={[s]:100,[i]:50,[l]:100,[r]:150},w={[s]:0,[r]:1,[f]:2,[h]:2,[d]:2},M={[s]:.1,[r]:.2,[f]:.05,[h]:.05,[d]:.08},m=(...t)=>document.querySelector(...t);let v=[],p=[{m:'<h1>Game Name Here</h1>\n    <p>Your goal is to help the Japanese defeat the Mongols in their \n    invasion something something something about the divine wind etc etc etc.\n    i havent finished the placeholder text lol</p>\n    <button id="s">Start</button>',init:()=>{m("#s").onclick=()=>{c.screen=1,y()}}},{m:'<h1>Level Select</h1>\n    <p>Select a level below:</p>\n    <div id="l"></div>',init:async()=>{const t=m("#l"),e=new Uint8Array(await(await fetch("levels")).arrayBuffer());let n=e[0],o=1;for(let t=0;t<n;t++){let t=e[o++],n=(new TextDecoder).decode(e.slice(o,o+=t)),a=e[o++],c=[];for(let t=0;t<a;t++)c.push({v:e[o++],type:e[o++]});v.push({name:n,data:c})}let a=0;for(const e of v){let n=a;const o=document.createElement("button");o.innerHTML=`<div class="lvl"><h2>${e.name}</h2></div>`,t.appendChild(o),o.onclick=()=>{c.screen=2,c.M=n,y()},a++}console.log(v)}},{m:'<div id="c"></div>',init:async()=>{console.log(v),c.units=v[c.M].data.map((t=>({i:t.type,x:t.v%16/16,y:(t.v>>4)/16,dx:0,dy:0,l:u[t.type],p:u[t.type],r:0}))),console.log("units",c.units),m("#c");const{canvas:t,loop:e,u:n}=await a();game.appendChild(t);let o=0;!function t(){o++;for(const t of c.units){for(const e of c.units){const n=Math.atan2(e.y-t.y,e.x-t.x),a=Math.hypot(e.y-t.y,e.x-t.x),h=()=>{let e=n;e+2*Math.PI-t.r<Math.PI&&(e+=2*Math.PI),t.r=.01*e+.99*t.r,t.r>2*Math.PI&&(t.r-=2*Math.PI),t.r<0&&(t.r+=2*Math.PI)};if(t!==e)switch(t.i){case s:case i:if(-1===[l,r].indexOf(e.i))break;if(h(),o%60==1&&c.units.push({i:f,x:t.x,y:t.y,dx:.8*Math.cos(n),dy:.8*Math.sin(n),r:n,l:650}),a<.1)break;t.dx+=5e-4*Math.cos(n),t.dy+=5e-4*Math.sin(n),t.r=n;break;case l:case r:if(-1===[s,i].indexOf(e.i))break;if(h(),o%240==1&&c.units.push({i:d,x:t.x,y:t.y,dx:.6*Math.cos(n),dy:.6*Math.sin(n),r:n,l:250}),a<.1)break;t.dx+=5e-4*Math.cos(n),t.dy+=5e-4*Math.sin(n)}}switch(t.i){case d:case f:case h:t.l--}const e=4*(Math.floor(128*t.x)+128*Math.floor(128*t.y)),a=.5*n[e],u=.5*n[e+1],w=-1===[f,h,d].indexOf(t.i)?.015:.003;t.dx=t.dx*(1-w)+a*w,t.dy=t.dy*(1-w)+u*w,t.x+=.01*t.dx,t.y+=.01*t.dy,t.dx*=.997,t.dy*=.997}e(),c.units=c.units.filter((t=>t.l>0)),requestAnimationFrame(t)}()}}];async function y(){const t=m("#game"),e=p[c.screen];t.innerHTML=e.m,e.init()}y();
