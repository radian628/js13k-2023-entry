let t=480,e=270,n=128;async function a(t,e,n,a){const o=await async function(t){return(await(await fetch(t)).text()).replace(/\/\*PERLIN\*\//g,await(await fetch("perlin.frag")).text())}(e),c=t.createShader(n);return t.shaderSource(c,o),t.compileShader(c),function(t,e,n){const a=t.getShaderInfoLog(e);a&&console.error(n+"\n",a)}(t,c,e),t.attachShader(a,c),c}async function o(t,e,n){const o=t.createProgram();await a(t,e,t.VERTEX_SHADER,o),await a(t,n,t.FRAGMENT_SHADER,o),t.linkProgram(o);const c=t.getProgramInfoLog(o);return c&&console.error(e,n+"\n",c),o}function c(t,e,n,a,o,c){const s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,a,e,n,0,o,c,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),s}function s(t,e,n){const a=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,a);const o=c(t,e,n,t.RGBA32F,t.RGBA,t.FLOAT);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,o,0);const s=c(t,e,n,t.RGBA32F,t.RGBA,t.FLOAT);return t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT1,t.TEXTURE_2D,s,0),{t:a,o:o,color:s}}async function i(){const a=document.createElement("canvas");a.id="fluid-canvas",a.width=1920,a.height=1080;const i=a.getContext("webgl2",{antialias:!1});console.log(i.getExtension("EXT_color_buffer_float")),console.log(i.getExtension("OES_texture_float_linear")),i.viewport(0,0,a.width,a.height),i.clearColor(1,0,0,1),i.clear(i.COLOR_BUFFER_BIT);const u=i.createVertexArray();i.bindVertexArray(u);const M=await async function(t){const e=new Int8Array(await(await fetch("assets")).arrayBuffer());console.log("assets",e);const n=e[0];let a=1;const o=[];for(let c=0;c<n;c++){let n=e[a++];n<0&&(n=256+n);const c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,e.slice(a,a+3*n),t.STATIC_DRAW),console.log("vertices",Array.from(e.slice(a,a+3*n)).map((t=>t/128))),a+=3*n;let s=e[a++];s<0&&(s=256+s),s*=3;const i=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.slice(a,a+s),t.STATIC_DRAW),console.log("indices",e.slice(a,a+s)),a+=s,o.push([c,i,s])}return o}(i),m=await o(i,"3d.vert","3d.frag"),[y,b,g,k,x,_,A,F]=await Promise.all(["advect.frag","divergence.frag","pressure.frag","final.frag","blit.frag","init.frag","display.frag","circle.frag"].map((t=>o(i,"blit.vert",t))));let P,S,E,L=s(i,t,e),G=s(i,t,e),I=s(i,n,n);const N=()=>{a.width=Math.min(window.innerWidth,16*window.innerHeight/9),a.height=9*a.width/16,P=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,P),E=c(i,a.width,a.height,i.RGBA,i.RGBA,i.UNSIGNED_BYTE),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,E,0),S=c(i,a.width,a.height,i.DEPTH_COMPONENT16,i.DEPTH_COMPONENT,i.UNSIGNED_SHORT),i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,S,0)};window.addEventListener("resize",N),N();const T=function(t){const e=new Float32Array([-1,-1,1,-1,-1,1,1,-1,-1,1,1,1]),n=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),n}(i);function q(){i.bindFramebuffer(i.DRAW_FRAMEBUFFER,G.t),i.drawBuffers([i.COLOR_ATTACHMENT0]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,L.o)}function z(){[L,G]=[G,L],q()}i.bindFramebuffer(i.FRAMEBUFFER,L.t),i.viewport(0,0,t,e),i.bindBuffer(i.ARRAY_BUFFER,T),i.vertexAttribPointer(0,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(0),i.drawBuffers([i.COLOR_ATTACHMENT0,i.COLOR_ATTACHMENT1]),i.useProgram(_),i.drawArrays(i.TRIANGLES,0,6);let D=[0,0],H=[0,0];a.addEventListener("mousemove",(t=>{D=[t.offsetX/a.width,t.offsetY/a.height]}));let J=!1,O=0;a.addEventListener("mousedown",(t=>{O=t.button,J=!0,H=[t.offsetX/a.width,t.offsetY/a.height],t.preventDefault()}));let R=[0,0];document.addEventListener("mouseup",(t=>{J=!1,pendingGust=!0;let e=t.offsetX/a.width-H[0],n=t.offsetY/a.height-H[1];R=[e,n],console.log(R),t.preventDefault()})),document.oncontextmenu=()=>!1;let U=0;function X(t,e,n,a,o,c=0){"number"==typeof a&&(a=[a,a,a]),i.uniformMatrix4fv(i.getUniformLocation(m,"vp"),!1,[1.125,0,0,0,0,1*Math.cos(1.3),1*-Math.sin(1.3),0,0,2*Math.sin(1.3),2*Math.cos(1.3),0,-1,-1,0,1]);for(let s=0;s<2;s++)i.bindBuffer(i.ARRAY_BUFFER,M[t][0]),i.vertexAttribPointer(0,3,i.BYTE,!0,0,0),i.enableVertexAttribArray(0),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,M[t][1]),i.uniformMatrix4fv(i.getUniformLocation(m,"m"),!1,[Math.cos(o)*a[0],0,Math.sin(o)*a[0],0,0,1*a[1]*(1===s?0:1),0,0,-Math.sin(o)*a[2],0,Math.cos(o)*a[2],0,e,0,n,1]),i.uniform1i(i.getUniformLocation(m,"mode"),0===s?c:1),i.drawElements(i.TRIANGLES,M[t][2],i.UNSIGNED_BYTE,0)}function Y(t,e,n,...a){for(let o=-16/9;o<2;o+=16/9)for(let c=-1;c<2;c++){const s=t=>.7-Math.abs(t-.5);Math.min(s(9*(e+o)/16),s(n+c))<0||X(t,e+o,n+c,...a)}}const $=i.createBuffer();i.bindBuffer(i.PIXEL_PACK_BUFFER,$),i.bufferData(i.PIXEL_PACK_BUFFER,262144,i.DYNAMIC_READ);const j=i.createBuffer();i.bindBuffer(i.PIXEL_PACK_BUFFER,j),i.bufferData(i.PIXEL_PACK_BUFFER,262144,i.DYNAMIC_READ);const B=new Float32Array(65536),C=new Float32Array(65536);return{canvas:a,loop:function(){i.bindFramebuffer(i.READ_FRAMEBUFFER,L.t),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,I.t),i.readBuffer(i.COLOR_ATTACHMENT0),i.drawBuffers([i.COLOR_ATTACHMENT0]),i.blitFramebuffer(0,0,t,e,0,0,n,n,i.COLOR_BUFFER_BIT,i.LINEAR),i.readBuffer(i.COLOR_ATTACHMENT1),i.drawBuffers([i.NONE,i.COLOR_ATTACHMENT1]),i.blitFramebuffer(0,0,t,e,0,0,n,n,i.COLOR_BUFFER_BIT,i.LINEAR),i.bindFramebuffer(i.READ_FRAMEBUFFER,I.t),i.bindBuffer(i.PIXEL_PACK_BUFFER,$),i.readBuffer(i.COLOR_ATTACHMENT0),i.readPixels(0,0,n,n,i.RGBA,i.FLOAT,0),i.bindBuffer(i.PIXEL_PACK_BUFFER,j),i.readBuffer(i.COLOR_ATTACHMENT1),i.readPixels(0,0,n,n,i.RGBA,i.FLOAT,0);const o=i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0);q(),i.viewport(0,0,t,e),i.useProgram(y),i.uniform1i(i.getUniformLocation(y,"fields"),0),i.drawArrays(i.TRIANGLES,0,6),z(),i.useProgram(b),i.drawArrays(i.TRIANGLES,0,6),z(),i.useProgram(g);for(let t=0;t<20;t++)i.drawArrays(i.TRIANGLES,0,6),z();i.useProgram(k),i.drawBuffers([i.COLOR_ATTACHMENT0,i.COLOR_ATTACHMENT1]),i.uniform1i(i.getUniformLocation(k,"fields"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,L.color),i.uniform1i(i.getUniformLocation(k,"color"),1),i.uniform1i(i.getUniformLocation(k,"gust_type"),2===O?1:0),i.uniform2fv(i.getUniformLocation(k,"force_pos"),[H[0],1-H[1]]);let c=Math.hypot(...R);0==c&&(c=1),i.uniform2fv(i.getUniformLocation(k,"force_vec"),[R[0]/c*2e3*Math.min(c,.25),-R[1]/c*2e3*Math.min(c,.25)]),R=[0,0],i.drawArrays(i.TRIANGLES,0,6),z(),i.useProgram(F);for(const t of r.units)if(t.i===w){const e=1===t.l;i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,L.o),i.uniform1i(i.getUniformLocation(F,"fields"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,L.color),i.uniform1i(i.getUniformLocation(F,"colors"),1),i.drawBuffers([i.COLOR_ATTACHMENT0,i.COLOR_ATTACHMENT1]),i.uniform1f(i.getUniformLocation(F,"force_factor"),e?2:0),i.uniform2f(i.getUniformLocation(F,"circle"),9*t.x/16,t.y),i.uniform4f(i.getUniformLocation(F,"radii"),0,e?.03:.003,0,e?.08:0),i.uniform4f(i.getUniformLocation(F,"colors_change"),0,e?4:.3,0,e?2:0),i.drawArrays(i.TRIANGLES,0,6),z()}i.useProgram(m),i.uniform1i(i.getUniformLocation(m,"fields"),0),i.uniform1f(i.getUniformLocation(m,"time"),U),i.enable(i.DEPTH_TEST),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,P),i.viewport(0,0,a.width,a.height),i.clearColor(.7,.75,.85,0),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);for(const t of r.units){if(void 0===p[t.i])continue;const e=t.x,n=t.y;switch(Y(p[t.i],e,n,v[t.i],t.r),t.i){case l:case f:Y(3,e,n,.1,0,3);break;case h:case d:Y(3,e,n,.1,0,4)}t.h&&Y(4,e,n-.08,[t.l/t.h*.06,.1,.04],0,5)}J&&X(2,16*H[0]/9,1-H[1],2*Math.min(Math.hypot(-(D[1]-H[1]),D[0]-H[0]),.25),Math.atan2(-(D[1]-H[1]),D[0]-H[0]),2),i.bindBuffer(i.ARRAY_BUFFER,T),i.vertexAttribPointer(0,2,i.FLOAT,!1,0,0),i.disable(i.DEPTH_TEST),i.useProgram(A),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,null),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,L.color),i.uniform1i(i.getUniformLocation(A,"atmosphere"),0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,E),i.uniform1i(i.getUniformLocation(A,"render_layer"),1),i.uniform2fv(i.getUniformLocation(A,"rand_noise"),[Math.random(),Math.random()]),i.drawArrays(i.TRIANGLES,0,6),U++;const s=i.getParameter(i.MAX_CLIENT_WAIT_TIMEOUT_WEBGL);i.clientWaitSync(o,i.SYNC_FLUSH_COMMANDS_BIT,s),i.bindBuffer(i.PIXEL_PACK_BUFFER,$),i.getBufferSubData(i.PIXEL_PACK_BUFFER,0,B),i.bindBuffer(i.PIXEL_PACK_BUFFER,j),i.getBufferSubData(i.PIXEL_PACK_BUFFER,0,C),i.viewport(0,0,t,e),i.u=D},M:B,m:C}}let r={screen:0,p:0,units:[]};const l=0,f=1,h=2,d=3,u=4,M=5,w=6,m={[l]:1e3,[f]:500,[h]:1e3,[d]:1500},p={[l]:0,[f]:0,[h]:0,[d]:1,[u]:2,[M]:2},v={[l]:.035,[f]:.02,[h]:.035,[d]:.05,[u]:.025,[M]:.025,[w]:.04};function y(t){return t===l||t===f}const b=(...t)=>document.querySelector(...t);let g=[],k=[{v:'<h1>Game Name Here</h1>\n    <p>Your goal is to help the Japanese defeat the Mongols in their \n    invasion something something something about the divine wind etc etc etc.\n    i havent finished the placeholder text lol</p>\n    <button id="s">Start</button>',init:()=>{b("#s").onclick=()=>{r.screen=1,x()}}},{v:'<h1>Level Select</h1>\n    <p>Select a level below:</p>\n    <div id="l"></div>',init:async()=>{const t=b("#l"),e=new Uint8Array(await(await fetch("levels")).arrayBuffer());let n=e[0],a=1;for(let t=0;t<n;t++){let t=e[a++],n=(new TextDecoder).decode(e.slice(a,a+=t)),o=e[a++],c=[];for(let t=0;t<o;t++)c.push({g:e[a++],type:e[a++]});g.push({name:n,data:c})}let o=0;for(const e of g){let n=o;const a=document.createElement("button");a.innerHTML=`<div class="lvl"><h2>${e.name}</h2></div>`,t.appendChild(a),a.onclick=()=>{r.screen=2,r.p=n,x()},o++}}},{v:'<div id="c"></div>',init:async()=>{r.units=g[r.p].data.map((t=>({i:t.type,x:t.g%16/16*(16/9),y:(t.g>>4)/16,dx:0,dy:0,l:m[t.type],h:m[t.type],r:0,k:0})));const t=b("#c"),{canvas:e,loop:a,M:o,m:c}=await i();t.appendChild(e),function t(){const e=(t,e)=>({dir:Math.atan2(e.y-t.y,e.x-t.x),_:Math.hypot(e.y-t.y,e.x-t.x)});for(const m of r.units){function s(t,e){return 4*(Math.floor(t*n*9/16)+Math.floor(e*n)*n)}const p=t=>Math.hypot(t.x-m.x,t.y-m.y),v=t=>{let e=t;e+2*Math.PI-m.r<Math.PI&&(e+=2*Math.PI),m.r=.01*e+.99*m.r,m.r>2*Math.PI&&(m.r-=2*Math.PI),m.r<0&&(m.r+=2*Math.PI)};let b=(t=>r.units.filter((e=>-1!=t.indexOf(e.i))).filter((t=>{if(m.type===f)return!0;let e=m.x,n=m.y;const a=1e3;let o=(t.x-m.x)/a,i=(t.y-m.y)/a,r=Math.hypot(o,i),l=0,h=0;for(let t=0;t<a;t++){const t=s(e+0*Math.random(),n+0*Math.random()),a=c[t+1];a>.5&&h++,l+=a*r,e+=o,n+=i}return console.log(l),l<.2&&h<100})).sort(((t,e)=>p(t)-p(e)))[0])(y(m.i)?[h,d]:[l,f]);const{dir:g,_:k}=b?e(m,b):{dir:0,_:0};(y(i=m.i)||i===h||i===d)&&(v(g),m.k--);const x=s(m.x,m.y);switch(m.i){case h:case l:if(!b)break;if(m.k<0&&k<.7&&(r.units.push({i:m.i===l?u:M,x:m.x,y:m.y,dx:.8*Math.cos(g),dy:.8*Math.sin(g),r:g,l:650}),m.k=120),k<.1)break;m.dx+=5e-4*Math.cos(g),m.dy+=5e-4*Math.sin(g),m.r=g;break;case f:if(!b)break;if(k<.08&&(b.l-=1.5),k<.05)break;m.dx+=5e-4*Math.cos(g),m.dy+=5e-4*Math.sin(g),m.r=g;break;case d:{if(!b)break;const{dir:E,_:L}=e(m,b);if(m.k<0&&L<.55&&(r.units.push({i:w,x:m.x,y:m.y,dx:.4*Math.cos(E),dy:.4*Math.sin(E),r:E,l:250}),m.k=360),L<.1)break;m.dx+=5e-4*Math.cos(E),m.dy+=5e-4*Math.sin(E);break}}for(const G of r.units){const{dir:I,_:N}=e(m,G);if(m!==G)switch(m.i){case u:if(-1===[h,d].indexOf(G.i))break;N<.03&&m.l>1&&(m.l=1,G.l-=10);break;case M:case w:if(-1===[l,f].indexOf(G.i))break;N<.03&&m.l>2&&(m.l=2,G.l-=m.i===M?10:0)}}switch(m.i){case w:case u:case M:m.l--}const _=(t,e)=>t-Math.floor(t/e)*e,A=c[x+3],F=1*o[x],P=1*o[x+1],S=-1===[u,M,w].indexOf(m.i)?.007:.003;-1!=[l,f,h,d].indexOf(m.i)&&(m.l-=1*Math.max(A-.1,0)),m.dx=m.dx*(1-S)+F*S,m.dy=m.dy*(1-S)+P*S,m.x+=.01*m.dx,m.y+=.01*m.dy,m.dx*=.997,m.dy*=.997,m.x=_(m.x,16/9),m.y=_(m.y,1)}var i;a(),r.units=r.units.filter((t=>t.l>0)),requestAnimationFrame(t)}()}}];async function x(){const t=b("#game"),e=k[r.screen];t.innerHTML=e.v,e.init()}x(),window.gameState=r;
